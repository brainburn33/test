name: GitHub-RDP Google Drive Test & Auto-Restart

on:
  workflow_dispatch:

jobs:
  rdp-test:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install rclone
        shell: powershell
        run: |
          Write-Host "Installing rclone..."
          Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
          Expand-Archive rclone.zip -DestinationPath rclone
          Copy-Item rclone\rclone-*\rclone.exe -Destination "C:\Windows\System32\rclone.exe" -Force
          rclone version

      - name: Create Google Drive key from secret (UTF8 without BOM)
        shell: powershell
        run: |
          $key = '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}'
          $path = "$env:USERPROFILE\gdrive-key.json"
          
          # Нормализуем переносы строк
          $key = $key -replace "`r", ""
          $key = $key -replace "\\n", "`n"
          
          # Записываем файл без BOM
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText($path, $key, $utf8NoBom)
          Write-Host "Google Drive key file created without BOM at $path"

      - name: Configure rclone with Google Drive
        shell: powershell
        run: |
          Write-Host "Configuring rclone..."
          mkdir "$env:USERPROFILE\.config\rclone" -Force
          $rcloneConfig = @"
          [gdrive]
          type = drive
          scope = drive.file
          service_account_file = $env:USERPROFILE\gdrive-key.json
          "@
          Set-Content -Path "$env:USERPROFILE\.config\rclone\rclone.conf" -Value $rcloneConfig -Encoding UTF8
          Write-Host "rclone configured successfully"

      - name: Create test file and upload to Google Drive
        shell: powershell
        run: |
          # Создаем тестовый файл
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $content = "GitHub Actions successfully uploaded this file at $timestamp"
          $testFilePath = "./test-upload.txt"
          
          # Записываем содержимое в файл
          Set-Content -Path $testFilePath -Value $content -Encoding UTF8
          Write-Host "Test file created: $testFilePath"
          Write-Host "Content: $content"
          
          # Загружаем файл в Google Drive
          Write-Host "Uploading file to Google Drive..."
          rclone copy $testFilePath gdrive:/GitHub-RDP --progress
          Write-Host "File uploaded successfully!"

      - name: Download back from Google Drive (check)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path ./downloaded
          rclone copy gdrive:/GitHub-RDP ./downloaded --progress
          Write-Host "Downloaded files:"
          Get-ChildItem ./downloaded -Recurse
          
          # Проверяем содержимое скачанного файла
          if (Test-Path "./downloaded/test-upload.txt") {
            $downloadedContent = Get-Content "./downloaded/test-upload.txt"
            Write-Host "Downloaded file content: $downloadedContent"
          }

      - name: Restart Workflow via GitHub API
        shell: powershell
        run: |
          $repo = "${{ github.repository }}"
          $token = "${{ secrets.GITHUB_TOKEN }}"
          $workflowFile = "123.yml"
          $apiUrl = "https://api.github.com/repos/$repo/actions/workflows/$workflowFile/dispatches"
          
          Write-Host "Sending restart request to GitHub API..."
          $body = '{"ref": "main"}'
          
          try {
            Invoke-RestMethod -Uri $apiUrl -Method Post -Headers @{
              Authorization = "token $token"
              Accept = "application/vnd.github+json"
            } -Body $body -ContentType "application/json"
            Write-Host "Workflow restart request sent successfully."
          } catch {
            Write-Host "Error restarting workflow: $_"
          }
