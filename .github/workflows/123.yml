name: GitHub-RDP Google Drive Test & Auto-Restart

on:
  workflow_dispatch:

jobs:
  rdp-test:
    runs-on: windows-latest
    timeout-minutes: 60  # можно увеличить при необходимости

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install rclone
        shell: powershell
        run: |
          Write-Host "Installing rclone..."
          Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
          Expand-Archive rclone.zip -DestinationPath rclone
          Copy-Item rclone\rclone-*\rclone.exe -Destination "C:\Windows\System32\rclone.exe" -Force
          rclone version

      - name: Create Google Drive key from secret (UTF8 without BOM)
        shell: powershell
        run: |
          $key = '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}'
          $path = "$env:USERPROFILE\gdrive-key.json"
          [System.IO.File]::WriteAllText($path, $key, [System.Text.Encoding]::UTF8)
          Write-Host "Google Drive key file created without BOM at $path"

      - name: Configure rclone with Google Drive
        shell: powershell
        run: |
          Write-Host "Configuring rclone..."
          mkdir "$env:USERPROFILE\.config\rclone" -Force
          $rcloneConfig = @"
          [gdrive]
          type = drive
          scope = drive.file
          service_account_file = $env:USERPROFILE\gdrive-key.json
          "@
          Set-Content -Path "$env:USERPROFILE\.config\rclone\rclone.conf" -Value $rcloneConfig -Encoding UTF8
          Write-Host "rclone configured successfully"

      - name: Create test file and upload to Google Drive
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $content = "GitHub Actions successfully uploaded this file at $timestamp"
          $key = $key -replace "r", ""    # удаляем CR
          $key = $key -replace "n", "`n"  # нормализуем LF

          $sw = New-Object System.IO.StreamWriter($path, $false, [System.Text.Encoding]::UTF8)
          $sw.Write($key)
          $sw.Close()
          Write-Host "Uploading file to Google Drive..."
          rclone copy "./test-upload.txt" gdrive:/GitHub-RDP --progress
          Write-Host "File uploaded successfully!"

      - name: Download back from Google Drive (check)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path ./downloaded
          rclone copy gdrive:/GitHub-RDP ./downloaded --progress
          Write-Host "Downloaded files:"
          Get-ChildItem ./downloaded -Recurse

      - name: Restart Workflow via GitHub API
        shell: powershell
        run: |
          $repo = "${{ github.repository }}"
          $token = "${{ secrets.GITHUB_TOKEN }}"
          $workflowFile = "github-rdp-test.yml"
          $apiUrl = "https://api.github.com/repos/$repo/actions/workflows/$workflowFile/dispatches"
          Write-Host "Sending restart request to GitHub API..."
          $body = '{"ref": "main"}'
          Invoke-RestMethod -Uri $apiUrl -Method Post -Headers @{
            Authorization = "token $token"
            Accept = "application/vnd.github+json"
          } -Body $body
          Write-Host "Workflow restart request sent successfully."
