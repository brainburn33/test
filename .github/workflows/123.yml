name: Google Drive + Auto Restart Test

on:
  workflow_dispatch:

jobs:
  test-drive:
    runs-on: windows-latest
    timeout-minutes: 15  # –æ–≥—Ä–∞–Ω–∏—á–∏–º –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª

    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ rclone
        shell: powershell
        run: |
          Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
          Expand-Archive rclone.zip -DestinationPath $env:TEMP\rclone
          Copy-Item "$env:TEMP\rclone\rclone-*\rclone.exe" -Destination "$env:SystemRoot\System32\rclone.exe"

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Drive –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        shell: powershell
        run: |
          echo "${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}" > service_account.json
          rclone config create gdrive drive scope drive.service_account service_account_file service_account.json

      - name: –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ Google Drive
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $content = "GitHub Actions —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ $timestamp"
          New-Item -Path "./test-upload.txt" -ItemType File -Value $content
          rclone copy ./test-upload.txt gdrive:/GitHub-Actions-Backup --progress

      - name: –¢–µ—Å—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑ Google Drive
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path ./downloaded
          rclone copy gdrive:/GitHub-Actions-Backup ./downloaded --progress
          Write-Host "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–∞—á–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏ ==="
          Get-ChildItem ./downloaded -Recurse

      - name: –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Workflow (—á–µ—Ä–µ–∑ GitHub API)
        if: always()
        shell: powershell
        run: |
          $token = "${{ secrets.GITHUB_TOKEN }}"
          $repo  = "${{ github.repository }}"
          $workflow = "gdrive-test.yml"
          $body = @{ ref = "${{ github.ref_name }}" } | ConvertTo-Json
          
          Write-Host "üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ workflow..."
          Invoke-RestMethod -Method Post 
            -Uri "https://api.github.com/repos/$repo/actions/workflows/$workflow/dispatches" 
            -Headers @{ Authorization = "Bearer $token"; "Accept" = "application/vnd.github+json" } `
            -Body $body

          Write-Host "‚úÖ Workflow —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
