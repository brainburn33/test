name: RDP with Custom Folders Persistence

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup cache key
        id: cache-key
        shell: powershell
        run: |
          $date = Get-Date -Format "yyyy-MM-dd"
          echo "cache_key=rdp-extended-$date" >> $env:GITHUB_OUTPUT
          Write-Host "Cache key: rdp-extended-$date"

      - name: Restore cached data
        id: cache-restore
        uses: actions/cache@v3
        with:
          path: ./cached-data
          key: ${{ steps.cache-key.outputs.cache_key }}
          restore-keys: |
            rdp-extended-

      - name: Restore user data from cache
        shell: powershell
        run: |
          $userProfile = "C:\Users\runneradmin"
          
          Write-Host "Restoring cached data..."
          
          if (Test-Path "./cached-data") {
            if (Test-Path "./cached-data/Desktop") {
              Copy-Item -Path "./cached-data/Desktop/*" -Destination "$userProfile\Desktop\" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Desktop restored"
            }
            
            if (Test-Path "./cached-data/Documents") {
              Copy-Item -Path "./cached-data/Documents/*" -Destination "$userProfile\Documents\" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Documents restored"
            }
            
            if (Test-Path "./cached-data/Downloads") {
              Copy-Item -Path "./cached-data/Downloads/*" -Destination "$userProfile\Downloads\" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Downloads restored"
            }
            
            if (Test-Path "./cached-data/AppData/Local/Roblox") {
              New-Item -ItemType Directory -Force -Path "$userProfile\AppData\Local" -ErrorAction SilentlyContinue
              Copy-Item -Path "./cached-data/AppData/Local/Roblox" -Destination "$userProfile\AppData\Local\Roblox" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ AppData\Local\Roblox restored"
            }
            
            if (Test-Path "./cached-data/Bloxtrap") {
              Copy-Item -Path "./cached-data/Bloxtrap" -Destination "C:\Bloxtrap" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Restored C:\Bloxtrap"
            }
            
            if (Test-Path "./cached-data/session-counter.txt") {
              $counter = [int](Get-Content "./cached-data/session-counter.txt") + 1
            } else {
              $counter = 1
            }
            Set-Content -Path "$userProfile\Desktop\session-counter.txt" -Value $counter
            
            Write-Host "`n=== Session #$counter ==="
          } else {
            Write-Host "No cached data found - starting fresh (Session #1)"
            Set-Content -Path "$userProfile\Desktop\session-counter.txt" -Value "1"
          }

      - name: Setup persistent storage
        shell: powershell
        run: |
          $userProfile = "C:\Users\runneradmin"
          New-Item -ItemType Directory -Force -Path "C:\PersistentData"
          
          $readmeContent = "=" * 50
          $readmeContent += "`nPERSISTENT STORAGE GUIDE`n"
          $readmeContent += "=" * 50
          $readmeContent += "`n`nWHAT GETS SAVED AUTOMATICALLY:`n"
          $readmeContent += "- Desktop files`n"
          $readmeContent += "- Documents`n"
          $readmeContent += "- Downloads`n"
          $readmeContent += "- AppData\Local\Roblox`n"
          $readmeContent += "- C:\Bloxtrap`n"
          $readmeContent += "`nSTORAGE LIMITS:`n"
          $readmeContent += "- Maximum cache size: 10 GB`n"
          $readmeContent += "- Cache expires after 7 days`n"
          $readmeContent += "- Auto-save every 30 minutes`n"
          $readmeContent += "`nSession started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n"
          $readmeContent += "=" * 50
          
          Set-Content -Path "C:\PersistentData\README.txt" -Value $readmeContent
          
          $WshShell = New-Object -ComObject WScript.Shell
          
          $Shortcut = $WshShell.CreateShortcut("$userProfile\Desktop\Persistent Data.lnk")
          $Shortcut.TargetPath = "C:\PersistentData"
          $Shortcut.IconLocation = "shell32.dll,4"
          $Shortcut.Save()
          
          $Shortcut2 = $WshShell.CreateShortcut("$userProfile\Desktop\AppData.lnk")
          $Shortcut2.TargetPath = "$userProfile\AppData"
          $Shortcut2.IconLocation = "shell32.dll,3"
          $Shortcut2.Save()
          
          $Shortcut3 = $WshShell.CreateShortcut("$userProfile\Desktop\Bloxtrap.lnk")
          $Shortcut3.TargetPath = "C:\Bloxtrap"
          $Shortcut3.IconLocation = "shell32.dll,8"
          $Shortcut3.Save()
          
          Write-Host "✅ Persistent storage configured"

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Static Password
        env:
          STATIC_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          $password = $env:STATIC_PASSWORD
          
          if ([string]::IsNullOrEmpty($password)) {
              Write-Host "⚠️ WARNING: RDP_PASSWORD secret not set, generating secure default password"
              $password = "RDP_" + (-join ((65..90) + (97..122) + (48..57) + (33,35,36,37,38,42,43,45,61) | Get-Random -Count 12 | ForEach-Object {[char]$_}))
              Write-Host "Generated password: $password"
          }
          
          secedit /export /cfg C:\secpol.cfg
          (Get-Content C:\secpol.cfg).replace("PasswordComplexity = 1", "PasswordComplexity = 0") | Out-File C:\secpol.cfg
          secedit /configure /db C:\windows\security\local.sdb /cfg C:\secpol.cfg /areas SECURITYPOLICY
          Remove-Item -Force C:\secpol.cfg -Confirm:$false
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          $userExists = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          
          if ($userExists) {
              Set-LocalUser -Name "RDP" -Password $securePass
              Write-Host "✅ Updated password for existing RDP user"
          } else {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
              Write-Host "✅ Created new RDP user"
          }
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }
          
          Write-Host "User RDP created/updated successfully"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Create connection info file
        shell: powershell
        run: |
          $userProfile = "C:\Users\runneradmin"
          $counter = Get-Content "$userProfile\Desktop\session-counter.txt"
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          
          $info = "=" * 50
          $info += "`nRDP CONNECTION INFO - Session #$counter`n"
          $info += "=" * 50
          $info += "`nAddress: $env:TAILSCALE_IP`n"
          $info += "Username: RDP`n"
          $info += "Password: $env:RDP_PASSWORD`n"
          $info += "`nStarted: $timestamp`n"
          $info += "Run ID: ${{ github.run_id }}`n"
          $info += "`nPERSISTENT LOCATIONS:`n"
          $info += "- Desktop`n"
          $info += "- Documents`n"
          $info += "- Downloads`n"
          $info += "- AppData\Local\Roblox`n"
          $info += "- C:\Bloxtrap`n"
          $info += "`nAuto-save interval: 30 minutes`n"
          $info += "=" * 50
          
          Set-Content -Path "$userProfile\Desktop\CONNECTION-INFO.txt" -Value $info
          Write-Host $info

      - name: Maintain Connection with Auto-Save
        run: |
          $userProfile = "C:\Users\runneradmin"
          $counter = Get-Content "$userProfile\Desktop\session-counter.txt"
          
          Write-Host "`n=== RDP ACCESS - Session #$counter ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: RDP"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "Auto-saved: Desktop, Documents, Downloads, AppData\Local\Roblox, C:\Bloxtrap"
          Write-Host "Auto-save every 30 minutes"
          Write-Host "========================================`n"
          
          $lastSave = Get-Date
          $saveInterval = 1  # минут
          
          while ($true) {
              $now = Get-Date
              $elapsed = ($now - $lastSave).TotalMinutes
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session #$counter Active | Next save in $([math]::Round($saveInterval - $elapsed)) min"
              
              if ($elapsed -ge $saveInterval) {
                  Write-Host "`n💾 Auto-saving data..."
                  
                  try {
                      Remove-Item -Path "./cached-data" -Recurse -Force -ErrorAction SilentlyContinue
                      New-Item -ItemType Directory -Force -Path "./cached-data" | Out-Null
                      
                      # Desktop
                      if (Test-Path "$userProfile\Desktop") {
                          $desktopSize = (Get-ChildItem "$userProfile\Desktop" -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1MB
                          Write-Host "  📁 Desktop size: $([math]::Round($desktopSize, 2)) MB"
                          Copy-Item -Path "$userProfile\Desktop" -Destination "./cached-data/Desktop" -Recurse -Force -ErrorAction SilentlyContinue
                          Write-Host "  ✅ Desktop saved"
                      }
                      
                      # Documents
                      if (Test-Path "$userProfile\Documents") {
                          Copy-Item -Path "$userProfile\Documents" -Destination "./cached-data/Documents" -Recurse -Force -ErrorAction SilentlyContinue
                          Write-Host "  ✅ Documents saved"
                      }
                      
                      # Downloads
                      if (Test-Path "$userProfile\Downloads") {
                          Copy-Item -Path "$userProfile\Downloads" -Destination "./cached-data/Downloads" -Recurse -Force -ErrorAction SilentlyContinue
                          Write-Host "  ✅ Downloads saved"
                      }
                      
                      # Roblox (with timeout protection)
                      if (Test-Path "$userProfile\AppData\Local\Roblox") {
                          Write-Host "  📦 Saving Roblox data (this may take a while)..."
                          New-Item -ItemType Directory -Force -Path "./cached-data/AppData/Local" -ErrorAction SilentlyContinue | Out-Null
                          
                          $robloxJob = Start-Job -ScriptBlock {
                              param($source, $dest)
                              Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue
                          } -ArgumentList "$userProfile\AppData\Local\Roblox", "./cached-data/AppData/Local/Roblox"
                          
                          # Wait max 5 minutes for Roblox copy
                          $robloxJob | Wait-Job -Timeout 300 | Out-Null
                          
                          if ($robloxJob.State -eq "Running") {
                              Write-Host "  ⚠️ Roblox copy timed out, stopping..."
                              Stop-Job -Job $robloxJob
                          } else {
                              Write-Host "  ✅ AppData\Local\Roblox saved"
                          }
                          
                          Remove-Job -Job $robloxJob -Force
                      }
                      
                      # Bloxtrap
                      if (Test-Path "C:\Bloxtrap") {
                          Copy-Item -Path "C:\Bloxtrap" -Destination "./cached-data/Bloxtrap" -Recurse -Force -ErrorAction SilentlyContinue
                          Write-Host "  ✅ C:\Bloxtrap saved"
                      }
                      
                      # Counter
                      Copy-Item "$userProfile\Desktop\session-counter.txt" -Destination "./cached-data/session-counter.txt" -Force -ErrorAction SilentlyContinue
                      
                      $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                      Write-Host "  ✅ All data saved at $timestamp`n"
                      
                  } catch {
                      Write-Host "  ⚠️ Error during save: $_"
                  }
                  
                  $lastSave = Get-Date
              }
              
              Start-Sleep -Seconds 60
          }

      - name: Final save before exit
        if: always()
        shell: powershell
        run: |
          Write-Host "`n💾 Final save before exit..."
          
          $userProfile = "C:\Users\runneradmin"
          
          try {
              Remove-Item -Path "./cached-data" -Recurse -Force -ErrorAction SilentlyContinue
              New-Item -ItemType Directory -Force -Path "./cached-data" | Out-Null
              
              Copy-Item -Path "$userProfile\Desktop" -Destination "./cached-data/Desktop" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Desktop saved"
              
              Copy-Item -Path "$userProfile\Documents" -Destination "./cached-data/Documents" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Documents saved"
              
              Copy-Item -Path "$userProfile\Downloads" -Destination "./cached-data/Downloads" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "✅ Downloads saved"
              
              if (Test-Path "$userProfile\AppData\Local\Roblox") {
                New-Item -ItemType Directory -Force -Path "./cached-data/AppData/Local" -ErrorAction SilentlyContinue | Out-Null
                
                Write-Host "Saving Roblox data (final save, may take time)..."
                $job = Start-Job -ScriptBlock {
                    param($src, $dst)
                    Copy-Item -Path $src -Destination $dst -Recurse -Force -ErrorAction SilentlyContinue
                } -ArgumentList "$userProfile\AppData\Local\Roblox", "./cached-data/AppData/Local/Roblox"
                
                $job | Wait-Job -Timeout 600 | Out-Null
                
                if ($job.State -eq "Completed") {
                    Write-Host "✅ AppData\Local\Roblox saved"
                } else {
                    Write-Host "⚠️ Roblox save timed out"
                    Stop-Job -Job $job
                }
                
                Remove-Job -Job $job -Force
              }
              
              if (Test-Path "C:\Bloxtrap") {
                Copy-Item -Path "C:\Bloxtrap" -Destination "./cached-data/Bloxtrap" -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "✅ C:\Bloxtrap saved"
              }
              
              Copy-Item "$userProfile\Desktop\session-counter.txt" -Destination "./cached-data/session-counter.txt" -Force -ErrorAction SilentlyContinue
              
              Write-Host "✅ Final data saved successfully!"
              
          } catch {
              Write-Host "⚠️ Error during final save: $_"
          }
